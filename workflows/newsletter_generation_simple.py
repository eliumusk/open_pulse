"""
ç®€åŒ–ç‰ˆ Newsletter Generation Workflow
ç”¨äºè°ƒè¯•å­˜å‚¨åŠŸèƒ½ï¼Œä¸è°ƒç”¨çœŸå®çš„ LLM å’Œæœç´¢ API
"""
from datetime import datetime
from textwrap import dedent
from agno.workflow import Workflow, Step
from agno.workflow.types import StepInput, StepOutput
from agno.db.sqlite import SqliteDb


def extract_user_context_simple(step_input: StepInput) -> StepOutput:
    """
    ç®€åŒ–ç‰ˆï¼šæå–ç”¨æˆ·ä¸Šä¸‹æ–‡
    ä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œç›´æ¥ä½¿ç”¨è¾“å…¥
    """
    additional_data = step_input.additional_data or {}
    user_id = additional_data.get("user_id", "default_user")
    
    print(f"ğŸ“Š Extracting context for user: {user_id}")
    
    interests = step_input.input or "technology, AI, and science"
    
    context_summary = dedent(f"""
        User Context Summary:
        - User ID: {user_id}
        - Interests: {interests}
        - Generated at: {datetime.now().isoformat()}
        
        Ready to generate newsletter.
    """).strip()
    
    print(f"âœ… Context extracted: {len(context_summary)} characters")
    
    return StepOutput(
        content=context_summary,
        success=True,
    )


def mock_research(step_input: StepInput) -> StepOutput:
    """
    ç®€åŒ–ç‰ˆï¼šæ¨¡æ‹Ÿç ”ç©¶
    ä¸è°ƒç”¨çœŸå®çš„æœç´¢ APIï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
    """
    print("ğŸ” Conducting mock research...")
    
    research_results = dedent("""
        Research Results:
        
        1. **AI Developments**
           - New breakthroughs in large language models
           - Improved reasoning capabilities
           - Better multimodal understanding
        
        2. **Quantum Computing**
           - Progress in error correction
           - New quantum algorithms
           - Commercial applications emerging
        
        3. **Space Exploration**
           - Mars mission updates
           - New telescope discoveries
           - Private space industry growth
    """).strip()
    
    print(f"âœ… Research completed: {len(research_results)} characters")
    
    return StepOutput(
        content=research_results,
        success=True,
    )


def generate_newsletter_simple(step_input: StepInput) -> StepOutput:
    """
    ç®€åŒ–ç‰ˆï¼šç”Ÿæˆ newsletter
    ä¸è°ƒç”¨ LLMï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
    """
    print("ğŸ“ Generating newsletter...")
    
    # è·å–å‰é¢æ­¥éª¤çš„å†…å®¹
    context = step_input.previous_step_content or "No context"
    
    # ç”Ÿæˆ newsletter
    newsletter = dedent(f"""
        # ğŸ“° Open Pulse Newsletter
        
        **Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        
        ---
        
        ## ğŸ¯ Your Personalized Tech Digest
        
        Welcome to your personalized newsletter! Here's what's happening in the world of technology.
        
        ## ğŸ¤– Artificial Intelligence
        
        The AI landscape continues to evolve rapidly. Recent developments show:
        
        - **Large Language Models**: New architectures are pushing the boundaries of what's possible
        - **Reasoning Capabilities**: Models are getting better at complex problem-solving
        - **Multimodal AI**: Integration of text, images, and other modalities is improving
        
        ### Key Insight
        > The focus is shifting from raw performance to reliability and practical applications.
        
        ## âš›ï¸ Quantum Computing
        
        Quantum computing is moving from theory to practice:
        
        - **Error Correction**: Major breakthroughs in maintaining quantum states
        - **New Algorithms**: Researchers are discovering novel quantum algorithms
        - **Commercial Applications**: First real-world use cases are emerging
        
        ### What This Means
        We're approaching the point where quantum computers can solve problems that classical computers cannot.
        
        ## ğŸš€ Space Exploration
        
        The final frontier is more accessible than ever:
        
        - **Mars Missions**: Ongoing exploration reveals new insights about the Red Planet
        - **Telescope Discoveries**: New observations are expanding our understanding of the universe
        - **Private Space Industry**: Commercial space travel is becoming a reality
        
        ### Looking Ahead
        The next decade will see unprecedented human activity in space.
        
        ---
        
        ## ğŸ’¡ Conclusion
        
        Technology continues to advance at an incredible pace. Stay curious, keep learning, and embrace the future!
        
        ---
        
        **Newsletter Stats:**
        - Topics covered: 3
        - Reading time: ~3 minutes
        - Generated by: Open Pulse AI
        
        ---
        
        *This is a simplified test newsletter. In production, content will be personalized based on your interests and recent conversations.*
    """).strip()
    
    print(f"âœ… Newsletter generated: {len(newsletter)} characters")
    
    return StepOutput(
        content=newsletter,
        success=True,
    )


def save_newsletter_simple(step_input: StepInput) -> StepOutput:
    """
    ç®€åŒ–ç‰ˆï¼šä¿å­˜ newsletter
    è¿”å›å®Œæ•´å†…å®¹ï¼ˆAgno ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    """
    additional_data = step_input.additional_data or {}
    user_id = additional_data.get("user_id", "default_user")
    newsletter_content = step_input.previous_step_content or step_input.input
    
    print(f"ğŸ’¾ Newsletter ready for user: {user_id}")
    
    newsletter_id = f"newsletter_{user_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    # è¿”å›å®Œæ•´çš„ newsletter å†…å®¹
    complete_output = dedent(f"""
        âœ… Newsletter Generated Successfully!
        
        Newsletter ID: {newsletter_id}
        User ID: {user_id}
        Generated at: {datetime.now().isoformat()}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        {newsletter_content}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ“Š Stats: {len(newsletter_content)} characters
    """).strip()
    
    print(f"âœ… Newsletter ready: {newsletter_id} ({len(newsletter_content)} chars)")
    
    return StepOutput(
        content=complete_output,
        success=True,
    )


def create_simple_newsletter_workflow(db: SqliteDb) -> Workflow:
    """
    åˆ›å»ºç®€åŒ–ç‰ˆçš„ Newsletter Generation Workflow
    
    ç‰¹ç‚¹ï¼š
    - ä¸è°ƒç”¨ LLM APIï¼ˆèŠ‚çœæˆæœ¬ï¼‰
    - ä¸è°ƒç”¨æœç´¢ APIï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
    - ä¸“æ³¨äºæµ‹è¯•å­˜å‚¨åŠŸèƒ½
    - ç”Ÿæˆå›ºå®šçš„æ¨¡æ¿å†…å®¹
    
    Args:
        db: æ•°æ®åº“å®ä¾‹
    
    Returns:
        Workflow å®ä¾‹
    """
    # Step 1: æå–ç”¨æˆ·ä¸Šä¸‹æ–‡
    extract_context_step = Step(
        name="Extract User Context",
        executor=extract_user_context_simple,
        description="Extract user context (simplified)",
    )
    
    # Step 2: æ¨¡æ‹Ÿç ”ç©¶
    research_step = Step(
        name="Mock Research",
        executor=mock_research,
        description="Mock research without API calls",
    )
    
    # Step 3: ç”Ÿæˆ newsletter
    generate_newsletter_step = Step(
        name="Generate Newsletter",
        executor=generate_newsletter_simple,
        description="Generate newsletter from template",
    )
    
    # Step 4: ä¿å­˜ newsletter
    save_newsletter_step = Step(
        name="Save Newsletter",
        executor=save_newsletter_simple,
        description="Return complete newsletter content",
    )
    
    # åˆ›å»º workflow
    workflow = Workflow(
        name="Simple Newsletter Workflow",
        description=dedent("""
            Simplified newsletter generation workflow for testing storage.
            
            This workflow:
            1. Extracts user context (no DB query)
            2. Mocks research (no API calls)
            3. Generates newsletter (template-based)
            4. Returns complete content (auto-saved by Agno)
            
            Perfect for debugging storage without API costs!
        """).strip(),
        db=db,
        store_events=True,  # å­˜å‚¨æ‰€æœ‰äº‹ä»¶ç”¨äºè°ƒè¯•
        steps=[
            extract_context_step,
            research_step,
            generate_newsletter_step,
            save_newsletter_step,
        ],
    )
    
    return workflow


# æµ‹è¯•ä»£ç 
if __name__ == "__main__":
    import asyncio
    from config.settings import DATABASE_FILE
    
    print("ğŸ§ª Testing Simple Newsletter Workflow")
    print("=" * 60)
    
    # åˆ›å»ºæ•°æ®åº“å®ä¾‹
    db = SqliteDb(db_file=DATABASE_FILE)
    
    # åˆ›å»º workflow
    workflow = create_simple_newsletter_workflow(db)
    
    # è¿è¡Œæµ‹è¯•
    async def test():
        result = await workflow.arun(
            input="I'm interested in AI, quantum computing, and space exploration",
            additional_data={
                "user_id": "test_user_123",
                "session_id": "test_session_456",
            },
        )
        
        print("\n" + "=" * 60)
        print("ğŸ“Š Result:")
        print("=" * 60)
        print(result.content)
        print("\n" + "=" * 60)
        print(f"âœ… Content length: {len(result.content)} characters")
    
    asyncio.run(test())

