# 📧 邮件服务配置指南

Open Pulse 支持在 Newsletter 生成后自动发送邮件通知给订阅者。

## 功能特性

- ✅ **HTML 邮件**：精美的 HTML 格式邮件
- ✅ **嵌入图片**：封面图片直接显示在邮件中（非附件）
- ✅ **多收件人**：支持同时发送给多个订阅者
- ✅ **自动发送**：Workflow 完成后自动发送
- ✅ **多邮箱支持**：Gmail、Outlook、QQ、163 等

## 快速开始

### 1. 配置环境变量

复制 `.env.example` 到 `.env` 并填写邮件配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```bash
# SMTP 服务器设置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587

# 发件人邮箱和密码
SENDER_EMAIL=your_email@gmail.com
SENDER_PASSWORD=your_app_password

# 发件人显示名称
SENDER_NAME=Open Pulse Newsletter
```

**注意**：收件人邮箱由 `trigger_workflow.sh` 中的 `USER_ID` 指定，不需要在 `.env` 中配置。

### 2. 配置 trigger_workflow.sh

编辑 `trigger_workflow.sh`，设置收件人邮箱：

```bash
USER_ID="your_email@example.com"  # 这个邮箱将收到 Newsletter
INTERESTS="AI, quantum computing, space exploration"
```

### 3. 获取邮箱密码

不同邮箱服务商需要不同的配置方式：

#### Gmail（推荐）

1. 访问 [Google App Passwords](https://myaccount.google.com/apppasswords)
2. 选择 "Mail" 和 "Other (Custom name)"
3. 输入名称如 "Open Pulse"
4. 点击 "Generate"
5. 复制生成的 16 位密码到 `SENDER_PASSWORD`

**注意**：
- 需要开启两步验证
- 不要使用你的 Gmail 登录密码

#### Outlook/Hotmail

```bash
SMTP_HOST=smtp-mail.outlook.com
SMTP_PORT=587
SENDER_EMAIL=your_email@outlook.com
SENDER_PASSWORD=your_outlook_password
```

#### QQ 邮箱

1. 登录 QQ 邮箱
2. 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
3. 开启 "SMTP 服务"
4. 生成授权码

```bash
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SENDER_EMAIL=your_qq_number@qq.com
SENDER_PASSWORD=your_authorization_code
```

#### 163 邮箱

1. 登录 163 邮箱
2. 设置 → POP3/SMTP/IMAP
3. 开启 "SMTP 服务"
4. 设置客户端授权密码

```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SENDER_EMAIL=your_email@163.com
SENDER_PASSWORD=your_authorization_code
```

### 3. 测试邮件发送

运行测试脚本：

```bash
python -c "from services.email_service import send_newsletter_email; \
send_newsletter_email('Test Newsletter Content', None)"
```

如果配置正确，你应该会收到测试邮件。

### 4. 运行 Workflow

现在运行 `trigger_workflow.sh`，Newsletter 生成后会自动发送邮件：

```bash
./trigger_workflow.sh
```

## 邮件内容

发送的邮件包含：

1. **精美的 HTML 模板**
   - 渐变色标题
   - 响应式设计
   - 专业排版

2. **封面图片**（如果生成）
   - 直接嵌入邮件正文
   - 不是附件，可以直接查看
   - 圆角阴影效果

3. **Newsletter 内容**
   - 格式化的文本
   - 清晰的段落分隔

4. **页脚信息**
   - 生成时间
   - 浏览器查看链接

## 高级配置

### 自定义收件人

可以在代码中动态指定收件人：

```python
from services.email_service import send_newsletter_email

send_newsletter_email(
    newsletter_content="Your content here",
    cover_image_path="/path/to/image.png",
    recipients=["custom@example.com", "another@example.com"]
)
```

### 自定义 SMTP 服务器

如果使用企业邮箱或自建邮件服务器：

```bash
SMTP_HOST=mail.your-company.com
SMTP_PORT=587
SENDER_EMAIL=newsletter@your-company.com
SENDER_PASSWORD=your_password
```

### 使用 SSL/TLS

某些邮箱服务器需要 SSL（端口 465）：

```bash
SMTP_PORT=465
```

代码会自动处理 TLS/SSL 连接。

## 故障排查

### 问题：邮件发送失败

**检查清单：**

1. ✅ 环境变量是否正确配置？
   ```bash
   echo $SENDER_EMAIL
   echo $SENDER_PASSWORD
   ```

2. ✅ 是否使用了应用专用密码（不是登录密码）？

3. ✅ SMTP 服务器和端口是否正确？

4. ✅ 防火墙是否阻止了 SMTP 连接？

5. ✅ 邮箱是否开启了 SMTP 服务？

### 问题：图片不显示

**可能原因：**

1. 图片文件不存在
2. 图片路径错误
3. 邮件客户端阻止了外部图片

**解决方案：**
- 图片是嵌入式的（使用 `cid:cover_image`），不依赖外部链接
- 检查 `static/images/` 目录是否有图片文件

### 问题：收不到邮件

**检查：**

1. 查看垃圾邮件文件夹
2. 检查收件人邮箱地址是否正确
3. 查看后端日志是否有错误信息

## 安全建议

1. **不要提交 `.env` 文件到 Git**
   - 已在 `.gitignore` 中排除
   - 只提交 `.env.example`

2. **使用应用专用密码**
   - 不要使用邮箱登录密码
   - 定期更换密码

3. **限制收件人数量**
   - 避免被标记为垃圾邮件
   - 大量发送请使用专业邮件服务

## 邮件预览

发送的邮件效果：

```
┌─────────────────────────────────────┐
│  📰 Open Pulse Newsletter           │
│  Your Personalized AI-Generated     │
│  Newsletter                         │
├─────────────────────────────────────┤
│                                     │
│  [封面图片 - 居中显示]              │
│                                     │
│  Newsletter 内容...                 │
│  段落 1                             │
│                                     │
│  段落 2                             │
│                                     │
├─────────────────────────────────────┤
│  Generated by Open Pulse            │
│  View in Browser                    │
│  December 07, 2024 at 03:24 PM      │
└─────────────────────────────────────┘
```

## 相关文件

- `services/email_service.py` - 邮件服务实现
- `agentos.py` - 集成邮件发送
- `.env.example` - 配置示例
- `docs/EMAIL_SETUP.md` - 本文档

## 下一步

配置完成后，你可以：

1. 设置 crontab 定时任务（参考 README.md）
2. 自定义邮件模板（编辑 `email_service.py`）
3. 添加更多收件人
4. 集成其他通知渠道（Slack、Discord 等）

